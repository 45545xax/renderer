#include <assert.h>
#include <stdlib.h>
#include "../core/api.h"
#include "../shaders/lambert_shader.h"
#include "lambert_scenes.h"

scene_t *lambert_craftsman_scene(void) {
    const char *meshes[] = {
        "assets/craftsman/anvil.obj",
        "assets/craftsman/floor.obj",
        "assets/craftsman/hammer.obj",
        "assets/craftsman/hotiron.obj",
        "assets/craftsman/shoulderpad0.obj",
        "assets/craftsman/shoulderpad1.obj",
        "assets/craftsman/smith.obj",
    };
    lambert_material_t materials[] = {
        {
            0.5f,
            0,
            NULL,
            "assets/craftsman/anvil_diffuse.tga",
            0,
            0,
        },
        {
            0.5f,
            1,
            NULL,
            "assets/craftsman/floor_diffuse.tga",
            1,
            0,
        },
        {
            0.5f,
            1,
            "assets/craftsman/smith_emission.tga",
            "assets/craftsman/smith_diffuse.tga",
            0,
            0,
        },
    };
    mat4_t transforms[] = {
        {{
            {  0.936571f,   0.000000f,   0.000000f,   0.000000f},
            {  0.000000f,   0.000000f,   0.936571f,   0.000000f},
            {  0.000000f,  -0.936571f,   0.000000f,  23.366537f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  1.259828f,   0.000000f,   0.000000f,   1.668093f},
            {  0.000000f,   0.000000f,   0.885767f,   0.000000f},
            {  0.000000f,  -1.259828f,   0.000000f,  10.833580f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.324427f,   0.217420f,   0.920584f,  11.052060f},
            { -0.852411f,   0.489096f,   0.184888f,  78.562383f},
            { -0.410056f,  -0.844697f,   0.344006f,  -8.390521f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.840193f,  -0.540788f,  -0.040288f, -34.668739f},
            { -0.102606f,  -0.085585f,  -0.991035f,  17.130267f},
            {  0.532492f,   0.836793f,  -0.127395f,  56.477256f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  1.000000f,   0.000000f,   0.000000f,   0.000000f},
            {  0.000000f,   0.000000f,   1.000000f,   0.000000f},
            {  0.000000f,  -1.000000f,   0.000000f,   0.000000f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.954568f,  -0.168932f,  -0.248769f,  10.987287f},
            {  0.171253f,  -0.392511f,   0.908502f,   8.632905f},
            { -0.243870f,  -0.936879f,  -0.335766f,  10.008259f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  1.000000f,   0.000000f,   0.000000f,   0.000000f},
            {  0.000000f,   0.000000f,   1.000000f,   0.000000f},
            {  0.000000f,  -1.000000f,   0.000000f,   0.000000f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
    };
    const char *spark_mesh = "assets/craftsman/spark.obj";
    lambert_material_t spark_material = {
        0.5f,
        0,
        "assets/craftsman/spark_emission.tga",
        "assets/craftsman/spark_diffuse.tga",
        1,
        1,
    };
    mat4_t spark_transforms[] = {
        {{
            {  0.104984f,   0.009185f,   0.000000f,   9.940392f},
            { -0.009185f,   0.104984f,   0.000000f,  23.342182f},
            { -0.000000f,  -0.000000f,   0.105385f,  23.126503f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            { -0.058686f,  -0.101646f,  -0.000000f,  -9.783746f},
            {  0.101646f,  -0.058686f,  -0.000000f,  24.797363f},
            {  0.000000f,  -0.000000f,   0.117371f,  23.126503f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.020583f,   0.001801f,   0.117176f,   1.669557f},
            { -0.049384f,  -0.107757f,   0.010331f,  11.562137f},
            {  0.106276f,  -0.050421f,  -0.017893f,  36.131775f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            { -0.032629f,  -0.046599f,   0.098531f,  -5.532722f},
            {  0.093198f,  -0.065258f,  -0.000000f,  20.369579f},
            {  0.056515f,   0.080712f,   0.056887f,  30.495888f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.050042f,   0.004378f,   0.087006f,   3.001525f},
            { -0.008756f,   0.100084f,   0.000000f,  23.325027f},
            { -0.086675f,  -0.007583f,   0.050233f,  17.500957f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            { -0.081984f,  -0.007173f,   0.057625f,  -2.616677f},
            { -0.008756f,   0.100084f,   0.000000f,  22.141081f},
            { -0.057406f,  -0.005022f,  -0.082297f,  21.804188f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.068182f,  -0.039782f,  -0.089026f,   6.102993f},
            { -0.049384f,  -0.107757f,   0.010331f,  16.986937f},
            { -0.084080f,   0.031031f,  -0.078261f,  15.379788f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.064266f,   0.091782f,  -0.019757f,   6.415188f},
            {  0.093198f,  -0.065258f,  -0.000000f,  20.369579f},
            { -0.011332f,  -0.016184f,  -0.112045f,  24.519733f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.037722f,   0.065337f,   0.089912f,   3.502418f},
            {  0.101646f,  -0.058686f,  -0.000000f,  24.797363f},
            {  0.044956f,   0.077866f,  -0.075445f,  32.513157f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.008723f,   0.000763f,  -0.100084f,  -0.887759f},
            { -0.008756f,   0.100084f,   0.000000f,  21.874636f},
            {  0.099703f,   0.008723f,   0.008756f,  27.667028f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            { -0.098563f,  -0.008623f,  -0.017446f, -16.835070f},
            { -0.008756f,   0.100084f,   0.000000f,  28.851065f},
            {  0.017379f,   0.001521f,  -0.098940f,  26.335102f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            { -0.067482f,  -0.005904f,   0.080729f,  -7.468997f},
            { -0.009185f,   0.104984f,   0.000000f,  27.920433f},
            { -0.080422f,  -0.007036f,  -0.067740f,  19.437935f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            { -0.098563f,  -0.008623f,   0.017446f,   0.181899f},
            { -0.008756f,   0.100084f,   0.000000f,  21.874636f},
            { -0.017379f,  -0.001520f,  -0.098940f,  22.585428f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            { -0.005688f,  -0.008123f,   0.113340f,   1.477568f},
            {  0.093198f,  -0.065258f,  -0.000000f,  20.274914f},
            {  0.065009f,   0.092843f,   0.009916f,  26.414782f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            { -0.053187f,  -0.092123f,   0.049603f,  -5.980136f},
            {  0.101646f,  -0.058686f,  -0.000000f,  24.797363f},
            {  0.024802f,   0.042958f,   0.106374f,  24.368771f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.076669f,   0.006708f,   0.064578f,   4.792371f},
            { -0.008756f,   0.100084f,   0.000000f,  22.141081f},
            { -0.064333f,  -0.005628f,   0.076962f,  22.409786f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.070770f,   0.006192f,  -0.071040f,   8.650177f},
            { -0.008756f,   0.100084f,   0.000000f,  23.325027f},
            {  0.070770f,   0.006192f,   0.071040f,  27.770390f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.059841f,  -0.059590f,  -0.054420f,   0.180720f},
            {  0.065058f,   0.075709f,  -0.011363f,  27.998913f},
            {  0.047749f,  -0.028472f,   0.083683f,  22.997925f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.015977f,   0.096166f,  -0.024297f,  21.038574f},
            { -0.069497f,   0.028413f,   0.066756f,  23.325027f},
            {  0.070770f,   0.006192f,   0.071040f,  27.770390f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
        {{
            {  0.059841f,  -0.059590f,  -0.054420f,  -2.989837f},
            {  0.065058f,   0.075709f,  -0.011363f,  34.510429f},
            {  0.047749f,  -0.028472f,   0.083683f,  22.997925f},
            {  0.000000f,   0.000000f,   0.000000f,   1.000000f},
        }},
    };
    vec4_t background = vec4_new(0.078f, 0.082f, 0.102f, 1);
    model_t **models = NULL;
    model_t *model;
    scene_t *scene;
    mat4_t scale, translation, root;
    int num_meshes = ARRAY_SIZE(meshes);
    int num_sparks = ARRAY_SIZE(spark_transforms);
    int i;

    assert((int)ARRAY_SIZE(materials) <= num_meshes);
    assert((int)ARRAY_SIZE(transforms) == num_meshes);

    translation = mat4_translate(-1.668f, -27.061f, -10.834f);
    scale = mat4_scale(0.016f, 0.016f, 0.016f);
    root = mat4_mul_mat4(scale, translation);
    for (i = 0; i < num_meshes; i++) {
        mat4_t transform = mat4_mul_mat4(root, transforms[i]);
        lambert_material_t material;
        if (i < (int)ARRAY_SIZE(materials)) {
            material = materials[i];
        } else {
            material = materials[ARRAY_SIZE(materials) - 1];
        }
        model = lambert_create_model(meshes[i], transform, material);
        darray_push(models, model);
    }
    for (i = 0; i < num_sparks; i++) {
        mat4_t transform = mat4_mul_mat4(root, spark_transforms[i]);
        model = lambert_create_model(spark_mesh, transform, spark_material);
        darray_push(models, model);
    }

    scene = (scene_t*)malloc(sizeof(scene_t));
    scene->background = background;
    scene->skybox     = NULL;
    scene->models     = models;

    return scene;
}
